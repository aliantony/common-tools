<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.antiy.asset.dao.AssetInstallTemplateDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.antiy.asset.entity.AssetInstallTemplate">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="number_code" property="numberCode"/>
        <result column="category_model" property="categoryModel"/>
        <result column="current_status" property="currentStatus"/>
        <result column="operation_system" property="operationSystem"/>
        <result column="operation_system_name" property="operationSystemName"/>
        <result column="description" property="description"/>
        <result column="gmt_create" property="gmtCreate"/>
        <result column="gmt_modified" property="gmtModified"/>
        <result column="create_user" property="createUser"/>
        <result column="modified_user" property="modifiedUser"/>
        <result column="status" property="status"/>
    </resultMap>
    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, name, number_code, category_model, current_status, operation_system, operation_system_name, description, gmt_create, gmt_modified, create_user, modified_user, status,executor
    </sql>

    <sql id="Table_Name">
        asset_install_template
    </sql>


    <sql id="IF_Base_Column_List">
        <if test=" name != null">
            name,
        </if>
        <if test=" numberCode != null">
            number_code,
        </if>
        <if test=" categoryModel != null">
            category_model,
        </if>
        <if test=" currentStatus != null">
            current_status,
        </if>
        <if test=" operationSystem != null">
            operation_system,
        </if>
        <if test=" operationSystemName != null">
            operation_system_name,
        </if>
        <if test=" description != null">
            description,
        </if>
        <if test=" gmtCreate != null">
            gmt_create,
        </if>
        <if test=" gmtModified != null">
            gmt_modified,
        </if>
        <if test=" createUser != null">
            create_user,
        </if>
        <if test=" modifiedUser != null">
            modified_user,
        </if>
        <if test=" status != null">
            status,
        </if>
        <if test=" executor != null">
            executor,
        </if>
    </sql>

    <sql id="IF_Value_Column_List">
        <if test=" name != null">
            #{name },
        </if>
        <if test=" numberCode != null">
            #{numberCode },
        </if>
        <if test=" categoryModel != null">
            #{categoryModel },
        </if>
        <if test=" currentStatus != null">
            #{currentStatus },
        </if>
        <if test=" operationSystem != null">
            #{operationSystem },
        </if>
        <if test=" operationSystemName != null">
            #{operationSystemName },
        </if>
        <if test=" description != null">
            #{description },
        </if>
        <if test=" gmtCreate != null">
            #{gmtCreate },
        </if>
        <if test=" gmtModified != null">
            #{gmtModified },
        </if>
        <if test=" createUser != null">
            #{createUser },
        </if>
        <if test=" modifiedUser != null">
            #{modifiedUser },
        </if>
        <if test=" status != null">
            #{status },
        </if>
        <if test=" executor != null">
            #{executor},
        </if>
    </sql>

    <sql id="Set_Column_List">
        <if test=" name != null">
            name = #{name },
        </if>
        <if test=" numberCode != null">
            number_code = #{numberCode },
        </if>
        <if test=" categoryModel != null">
            category_model = #{categoryModel },
        </if>
        <if test=" currentStatus != null">
            current_status = #{currentStatus },
        </if>
        <if test=" operationSystem != null">
            operation_system = #{operationSystem },
        </if>
        <if test=" operationSystemName != null">
            operation_system_name = #{operationSystemName },
        </if>
        <if test=" description != null">
            description = #{description },
        </if>
        <!-- <if test=" gmtCreate != null">
             gmt_create = #{gmtCreate },
         </if>-->
        <if test=" gmtModified != null">
            gmt_modified = #{gmtModified },
        </if>
        <!--    <if test=" createUser != null">
                create_user = #{createUser },
            </if>-->
        <if test=" modifiedUser != null">
            modified_user = #{modifiedUser },
        </if>
        <if test=" status != null">
            status = #{status },
        </if>
        <if test=" executor != null">
            executor = #{executor },
        </if>
    </sql>

    <sql id="Where_Column_List">
        <if test=" name != null and name !=''">
            and `name` like concat('%',replace(replace(replace(#{name},'\\','\\\\'),'_','\_'),'%','\%'),'%')
        </if>
        <if test=" numberCode != null and numberCode !=''">
            and number_code like concat('%',replace(replace(replace(#{numberCode},'\\','\\\\'),'_','\_'),'%','\%'),'%')
        </if>
        <if test=" categoryModel != null">
            and category_model = #{categoryModel }
        </if>
        <if test=" currentStatus != null">
            and current_status = #{currentStatus }
        </if>
        <if test=" operationSystem != null">
            and operation_system = #{operationSystem }
        </if>
        <if test=" operationSystemName != null">
            and operation_system_name = #{operationSystemName }
        </if>
        <if test=" description != null">
            and description = #{description }
        </if>
        <if test=" gmtCreate != null">
            and gmt_create = #{gmtCreate }
        </if>
        <if test=" gmtModified != null">
            and gmt_modified = #{gmtModified }
        </if>
        <if test=" createUser != null">
            and create_user = #{createUser }
        </if>
        <if test=" modifiedUser != null">
            and modified_user = #{modifiedUser }
        </if>
        <if test="operationSystems !=null and operationSystems.size >0">
            and operation_system in
            <foreach collection="operationSystems" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
    </sql>

    <insert id="insert" parameterType="com.antiy.asset.entity.AssetInstallTemplate" useGeneratedKeys="true"
            keyProperty="id" keyColumn="id">
        insert into
        <include refid="Table_Name"></include>
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <include refid="IF_Base_Column_List"></include>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <include refid="IF_Value_Column_List"></include>
        </trim>
    </insert>
    <update id="updateStatus" parameterType="com.antiy.asset.entity.AssetInstallTemplate">
        update
        <include refid="Table_Name"></include>
        <trim prefix="set" suffixOverrides=",">
            current_status = #{currentStatus },
            <if test=" gmtModified != null">
                gmt_modified = #{gmtModified },
            </if>
            <if test=" modifiedUser != null">
                modified_user = #{modifiedUser },
            </if>
        </trim>
        where id = #{id} and status=1
    </update>

    <update id="update" parameterType="com.antiy.asset.entity.AssetInstallTemplate">
        update
        <include refid="Table_Name"></include>

        <trim prefix="SET" suffixOverrides=",">
            <include refid="Set_Column_List"></include>
        </trim>

        where id = #{id} and status=1
    </update>

    <!-- 根据主键查询 -->
    <select id="getById" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>

        from
        <include refid="Table_Name"></include>
        where id = #{id} and status=1
    </select>

    <delete id="deleteById" parameterType="java.lang.String">
        delete from
        <include refid="Table_Name"></include>
        where id = #{id}
    </delete>

    <select id="getByWhere" resultMap="BaseResultMap" parameterType="java.util.Map">
        select
        <include refid="Base_Column_List"/>
        from
        <include refid="Table_Name"></include>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
        </trim>
    </select>

    <select id="findCount" resultType="int" parameterType="com.antiy.common.base.ObjectQuery">
        select count(1)
        from
        <include refid="Table_Name"></include>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            and status=1
            <include refid="Where_Column_List"></include>
            <if test="stringId !=null">
                and id=#{stringId}
            </if>
        </trim>
    </select>

    <select id="findQuery" resultMap="BaseResultMap" parameterType="com.antiy.common.base.ObjectQuery">
        select * from
        <include refid="Table_Name"></include>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            and status=1
            <include refid="Where_Column_List"></include>
        </trim>
        order by
        <if test="baselineId != null">
            gmt_modified
        </if>
        <if test="baselineId == null">
            gmt_create
        </if>
        desc
        <if test="pageSize !=-1">
            LIMIT #{pageSize} offset #{pageOffset}
        </if>
    </select>
    <select id="findByAssetIds" resultMap="BaseResultMap">
        SELECT
        *
        FROM
        asset_install_template
        WHERE

        id IN (
        SELECT
        asset.install_template_id
        FROM
        asset
        WHERE
        id IN
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>

        )
    </select>
    <update id="batchDeleteTemplate" parameterType="list">
        update
        <include refid="Table_Name"></include>
        <trim prefix="SET" suffixOverrides=",">
            status = 0,
            gmt_modified = #{gmtModified},
            modified_user=#{modifiedUser},
        </trim>
        where id in
        <foreach collection="ids" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        and current_status=2
    </update>

    <select id="queryTemplateById" resultType="com.antiy.asset.vo.response.AssetTemplateRelationResponse">
                SELECT
            ait.id AS stringId,
            ait.`name`,
            ait.number_code AS numberCode,
            ait.description,
            status,
            (
        SELECT
            count( * )
        FROM
            asset_software_install_template AS asit
            INNER JOIN asset_hard_soft_lib AS ahsl ON asit.software_id = ahsl.business_id
            AND asit.STATUS = 1
        WHERE
            asit.install_template_id = ait.id
            ) AS softNum,
            (
        SELECT
            count( * )
        FROM
            asset_patch_install_template AS apit
            INNER JOIN patch_info AS pi ON apit.patch_id = pi.id
            AND apit.STATUS = 1
        WHERE
            apit.install_template_id = ait.id
            ) AS patchNum
        FROM
            asset_install_template AS ait
        WHERE
             ait.id = #{templateId}
    </select>
    <select id="queryTemplateOs" resultType="com.antiy.asset.vo.response.AssetInstallTemplateOsResponse">
        SELECT DISTINCT operation_system as osCode,operation_system_name as osName FROM asset_install_template where status=1
    </select>
    <select id="queryTemplateStatus" resultType="int">
        SELECT  DISTINCT current_status  FROM `asset_install_template` where status=1 order by current_status ;
    </select>
    <select id="queryNumberCode" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT count(*) FROM `asset_install_template` WHERE number_code=#{numberCode} and status=1
    </select>
    <select id="queryOs" resultType="com.antiy.asset.vo.response.AssetInstallTemplateOsResponse">
        SELECT business_id as osCode,product_name as osName FROM `asset_cpe_filter`
        <trim prefixOverrides="and" prefix="where">
            <if test="osBusinessId !=null ">
                business_id=#{osBusinessId}
            </if>
            and status=1 and type='o' and (serial_name='windows' or serial_name='linux')
        </trim>
    </select>
    <select id="querySoftCount" resultType="java.lang.Integer" parameterType="com.antiy.asset.vo.query.PrimaryKeyQuery">
        select count(1) from asset_software_install_template where install_template_id = #{pid} and status = 1
    </select>
    <select id="querySoftList" resultType="com.antiy.asset.entity.AssetHardSoftLib"
            parameterType="com.antiy.asset.vo.query.PrimaryKeyQuery">
        select
            t2.id,
            t2.business_id as businessId,
            t2.number,
            t2.type,
            t2.supplier,
            t2.product_name as productName,
            t2.version,
            t2.upgrade_msg as upgradeMsg,
            t2.sys_version as sysVersion,
            t2.language,
            t2.soft_version as softVersion,
            t2.soft_platform as softPlatform,
            t2.hard_platform as hardPlatform,
            t2.other
        from asset_software_install_template t1 inner join asset_hard_soft_lib t2 on t1.software_id = t2.business_id
        where
        t1.install_template_id = #{pid} and t1.status = 1
    </select>
    <select id="queryPatchCount" resultType="java.lang.Integer"
            parameterType="com.antiy.asset.vo.query.PrimaryKeyQuery">
        select count(1) from asset_patch_install_template where install_template_id = #{pid} and status = 1
    </select>
    <select id="queryPatchList" resultType="com.antiy.asset.entity.PatchInfo"
            parameterType="com.antiy.asset.vo.query.PrimaryKeyQuery">
        select
            t2.id,
            patch_number as patchNumber,
            antiy_patch_number as antiyPatchNumber,
            patch_name as patchName,
            patch_level as patchLevel,
            path_source as pathSource,
            hotfix,
            user_interaction as userInteraction,
            exclusive_install as exclusiveInstall,
            network_status as networkStatus
        from asset_patch_install_template t1 inner join patch_info t2 on t1.patch_id = t2.id
        where
        t1.install_template_id = #{pid} and t1.status=1
    </select>
    <select id="queryBaselineTemplateType" parameterType="com.antiy.common.base.ObjectQuery"
            resultType="java.lang.Integer">
        select sw_type from baseline_template_hist where id=#{baselineId}
    </select>
    <select id="queryTemplateInfo" resultType="com.antiy.asset.vo.response.AssetInstallTemplateResponse"
            parameterType="com.antiy.common.base.ObjectQuery">

        SELECT
        ait.id as stringId,
        ait.id as templateId,
        ait.name as name,
        ait.number_code as numberCode,
        ait.gmt_modified as gmtModified,
        ait.description as description,
        ait.category_model as categoryModel,
        ait.current_status as currentStatus,
        ait.operation_system as operationSystem,
        ait.operation_system_name as operationSystemName,
        ait.gmt_create as gmtCreate,
        count(DISTINCT asit.software_id) as softNum,
        count(DISTINCT apit.patch_id) as patchNum
        FROM
        asset_install_template ait
        LEFT JOIN asset_software_install_template asit ON ait.id = asit.install_template_id AND asit.STATUS = 1
        LEFT JOIN asset_patch_install_template apit ON ait.id = apit.install_template_id AND apit.STATUS = 1
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            and ait.status=1
           <include refid="common_query"/>
            <if test="stringId !=null and stringId !=''">
                and ait.id=#{stringId}
            </if>
        </trim>
        GROUP BY ait.id
        order by ait.gmt_create desc
        <if test="pageSize !=-1">
            LIMIT #{pageSize} offset #{pageOffset}
        </if>
    </select>
    <insert id="insertBatchSoft" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateRequest">
        insert into asset_software_install_template
        (install_template_id,software_id,gmt_create,create_user)
        <trim prefix="values" suffix=";" suffixOverrides=",">
            <if test="softBussinessIds != null">
                <foreach collection="softBussinessIds" item="softBussinessId" separator=",">
                    (#{stringId},#{softBussinessId},#{gmtCreate},#{createUser})
                </foreach>
            </if>
        </trim>

    </insert>
    <insert id="insertBatchPatch" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateRequest">
        insert into asset_patch_install_template
        (install_template_id,patch_id,gmt_create,create_user)
        <trim prefix="values" suffix=";" suffixOverrides=",">
            <if test="patchIds != null">
                <foreach collection="patchIds" item="patchId" separator=",">
                    (#{stringId},#{patchId},#{gmtCreate},#{createUser})
                </foreach>
            </if>
        </trim>

    </insert>
    <insert id="insertTemplateCheckInfo" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateCheckRequest">
        insert into asset_install_template_check
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test=" stringId != null">
                install_template_id,
            </if>
            <if test=" userId != null">
                user_id,
            </if>
            <if test=" advice != null">
                advice,
            </if>
            <if test=" result != null">
                result,
            </if>
            <if test=" gmtCreate != null">
                gmt_create,
            </if>
            <if test=" gmtModified != null">
                gmt_modified,
            </if>
            <if test=" createUser != null">
                create_user,
            </if>
            <if test=" modifiedUser != null">
                modified_user,
            </if>

        </trim>

        <trim prefix="values (" suffix=");" suffixOverrides=",">
            <if test=" stringId != null">
                #{stringId},
            </if>
            <if test=" userId != null">
                #{userId},
            </if>
            <if test=" advice != null">
                #{advice},
            </if>
            <if test=" result != null">
                #{result},
            </if>
            <if test=" gmtCreate != null">
                #{gmtCreate},
            </if>
            <if test=" gmtModified != null">
                #{gmtModified},
            </if>
            <if test=" createUser != null">
                #{createUser},
            </if>
            <if test=" modifiedUser != null">
                #{modifiedUser},
            </if>

        </trim>

    </insert>

    <sql id="Set_InstallTemplate_Check_List">
        <if test=" advice != null">
            advice = #{advice },
        </if>
        <if test=" result != null">
            result = #{result },
        </if>
        <if test=" gmtModified != null">
            gmt_modified = #{gmtModified },
        </if>
        <if test=" modifiedUser != null">
            modified_user = #{modifiedUser },
        </if>
    </sql>
    <update id="deleteBatchSoft" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateRequest">
        update asset_software_install_template set status=0,gmt_modified=#{gmtModified},modified_user=#{modifiedUser}
        where install_template_id=#{stringId } and software_id
        <foreach collection="softBussinessIds" item="softBussinessId" open="in (" close=")" separator=",">
            #{softBussinessId}
        </foreach>
        and status=1
    </update>
    <update id="deleteBatchPatch" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateRequest">
        update asset_patch_install_template set status=0,gmt_modified=#{gmtModified},modified_user=#{modifiedUser}
        where install_template_id=#{stringId } and patch_id
        <foreach collection="patchIds" item="patchId" open="in (" close=")" separator=",">
            #{patchId}
        </foreach>
        and status=1
    </update>
    <select id="queryPatchIds" resultType="String"
            parameterType="com.antiy.asset.vo.query.PrimaryKeyQuery">
        select patch_id
        from asset_patch_install_template
        where
        install_template_id = #{pid} and status=1
    </select>
    <select id="queryPatchRelations" resultType="com.antiy.asset.entity.PatchInfo">
        select
            t2.id as id,
            patch_number as patchNumber,
            antiy_patch_number as antiyPatchNumber,
            patch_name as patchName,
            patch_level as patchLevel,
            path_source as pathSource,
            hotfix,
            user_interaction as userInteraction,
            exclusive_install as exclusiveInstall,
            network_status as networkStatus
        from asset_patch_install_template t1 inner join patch_info t2 on t1.patch_id = t2.id and t2.status = 1
        where
        t1.install_template_id = #{installTemplateId} and t1.status=1
    </select>
    <select id="querySoftIds" resultType="java.lang.Long">
        select software_id from asset_software_install_template where install_template_id = #{installTemplateId} and status = 1
    </select>
    <sql id="common_query">
        <if test=" name != null and name !=''">
            and ait.`name` like concat('%',replace(replace(replace(#{name},'\\','\\\\'),'_','\_'),'%','\%'),'%')
        </if>
        <if test=" numberCode != null and numberCode !=''">
            and ait.number_code like
            concat('%',replace(replace(replace(#{numberCode},'\\','\\\\'),'_','\_'),'%','\%'),'%')
        </if>
        <if test=" currentStatus != null">
            and ait.current_status = #{currentStatus }
        </if>
        <if test=" operationSystem != null">
            and ait.operation_system = #{operationSystem }
        </if>
        <if test=" operationSystemName != null">
            and ait.operation_system_name = #{operationSystemName }
        </if>
        <if test="operationSystems !=null and operationSystems.size >0">
        and ait.operation_system in
        <foreach collection="operationSystems" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        </if>
    </sql>
    <select id="CountFilterBlackItemTemplate" resultType="Integer"
            parameterType="com.antiy.common.base.ObjectQuery">
        select count(1) from ( SELECT
        DISTINCT ait.id AS stringId
        FROM
        asset_install_template ait
        LEFT JOIN asset_software_install_template asit ON ait.id = asit.install_template_id and asit.status=1
        LEFT JOIN asset_patch_install_template apit ON ait.id = apit.install_template_id and apit.status=1
        left join patch_info pi on pi.id=apit.patch_id and pi.`status`=1
        left join asset_hard_soft_lib ahsl on ahsl.business_id=asit.software_id AND ahsl.STATUS = 1
        LEFT JOIN ( SELECT DISTINCT
        ahsl.business_id AS software_business_id
        FROM
        baseline_template_hist bt
        LEFT JOIN baseline_template_software_hist bts ON bt.id = bts.template_hist_id
        AND bts.is_delete = 0
        LEFT JOIN asset_hard_soft_lib ahsl ON bts.software_id = ahsl.id
        AND ahsl.STATUS = 1
        WHERE
        bt.id = #{baselineId}) t on t.software_business_id=asit.software_id
        where ait.status=1
       <include refid="common_query"/>
        GROUP BY ait.id HAVING count(t.software_business_id)=0
        ) t
    </select>
    <select id="FilterBlackItemTemplate" resultType="com.antiy.asset.vo.response.AssetInstallTemplateResponse"
            parameterType="com.antiy.common.base.ObjectQuery">
        SELECT
        DISTINCT ait.id AS stringId,
        ait.id AS templateId,
        ait.NAME AS NAME,
        ait.number_code AS numberCode,
        ait.gmt_modified AS gmtModified,
        ait.description AS description,
        count( DISTINCT ahsl.business_id ) AS softNum,
        count( DISTINCT pi.id ) AS patchNum
        FROM
        asset_install_template ait
        LEFT JOIN asset_software_install_template asit ON ait.id = asit.install_template_id and asit.status=1
        LEFT JOIN asset_patch_install_template apit ON ait.id = apit.install_template_id and apit.status=1
        left join patch_info pi on pi.id=apit.patch_id and pi.`status`=1
        left join asset_hard_soft_lib ahsl on ahsl.business_id=asit.software_id AND ahsl.STATUS = 1
        LEFT JOIN ( SELECT DISTINCT
        ahsl.business_id AS software_business_id
        FROM
        baseline_template_hist bt
        LEFT JOIN baseline_template_software_hist bts ON bt.id = bts.template_hist_id
        AND bts.is_delete = 0
        LEFT JOIN asset_hard_soft_lib ahsl ON bts.software_id = ahsl.id
        AND ahsl.STATUS = 1
        WHERE
        bt.id = #{baselineId}) t on t.software_business_id=asit.software_id
        where ait.status=1
        <include refid="common_query"/>
        GROUP BY ait.id HAVING count(t.software_business_id)=0
        order by ait.gmt_modified desc
        <if test="pageSize !=-1">
            LIMIT #{pageSize} offset #{pageOffset}
        </if>
    </select>
    <select id="CountWhiteItemTemplate" resultType="Integer" parameterType="com.antiy.common.base.ObjectQuery">
        select count(1) from ( SELECT
        DISTINCT ait.id AS stringId
        FROM
        asset_install_template ait
        LEFT JOIN asset_software_install_template asit ON ait.id = asit.install_template_id and asit.status=1
        LEFT JOIN asset_patch_install_template apit ON ait.id = apit.install_template_id and apit.status=1
        left join patch_info pi on pi.id=apit.patch_id and pi.`status`=1
        left join asset_hard_soft_lib ahsl on ahsl.business_id=asit.software_id AND ahsl.STATUS = 1
        LEFT JOIN ( SELECT DISTINCT
        ahsl.business_id AS software_business_id
        FROM
        baseline_template_hist bt
        LEFT JOIN baseline_template_software_hist bts ON bt.id = bts.template_hist_id
        AND bts.is_delete =0
        LEFT JOIN asset_hard_soft_lib ahsl ON bts.software_id = ahsl.id
        AND ahsl.STATUS = 1
        WHERE
        bt.id = #{baselineId}) t on t.software_business_id=asit.software_id
        where ait.status=1 and asit.software_id is not null
        <include refid="common_query"/>
        GROUP BY ait.id HAVING count(t.software_business_id)=count(asit.software_id)
        ) t
    </select>
    <select id="findWhiteItemTemplate" resultType="com.antiy.asset.vo.response.AssetInstallTemplateResponse"
            parameterType="com.antiy.common.base.ObjectQuery">
        SELECT
        DISTINCT ait.id AS stringId,
        ait.id AS templateId,
        ait.NAME AS NAME,
        ait.number_code AS numberCode,
        ait.gmt_modified AS gmtModified,
        ait.description AS description,

        count( DISTINCT ahsl.business_id) AS softNum,
        count( DISTINCT pi.id) AS patchNum
        FROM
        asset_install_template ait
        LEFT JOIN asset_software_install_template asit ON ait.id = asit.install_template_id and asit.status=1
        LEFT JOIN asset_patch_install_template apit ON ait.id = apit.install_template_id and apit.status=1
        left join patch_info pi on pi.id=apit.patch_id and pi.`status`=1
        left join asset_hard_soft_lib ahsl on ahsl.business_id=asit.software_id AND ahsl.STATUS = 1
        LEFT JOIN ( SELECT DISTINCT
        ahsl.business_id AS software_business_id
        FROM
        baseline_template_hist bt
        LEFT JOIN baseline_template_software_hist bts ON bt.id = bts.template_hist_id
        AND bts.is_delete = 0
        LEFT JOIN asset_hard_soft_lib ahsl ON bts.software_id = ahsl.id
        AND ahsl.STATUS = 1
        WHERE
        bt.id = #{baselineId}) t on t.software_business_id=asit.software_id
        where ait.status=1 and asit.software_id is not null
        <include refid="common_query"/>
        GROUP BY ait.id HAVING count(t.software_business_id)=count(asit.software_id)
        order by ait.gmt_modified desc
        <if test="pageSize !=-1">
            LIMIT #{pageSize} offset #{pageOffset}
        </if>
    </select>
    <update id="deleteBatchPatchByPatchCode" parameterType="com.antiy.asset.vo.request.AssetInstallTemplateRequest">
        update asset_patch_install_template set status=0,gmt_modified=#{gmtModified},modified_user=#{modifiedUser}
        where patch_id in (
        SELECT id FROM `patch_info` where antiy_patch_number
        <foreach collection="patchIds" item="patchCode" open="in (" close=")" separator=",">
            #{patchCode}
        </foreach>
        )
        and status=1
    </update>
    <select id="findCountPatch" parameterType="String" resultType="java.lang.Integer">
        select count(1) from patch_info where id=#{patchId} and status=1
    </select>
    <select id="getParentNodesByNodes" resultType="java.lang.Long">
         SELECT
         node
         FROM
         (SELECT
         t1.node,IF(FIND_IN_SET(node, @pids) > 0, @pids:=CONCAT(@pids, ',', parent_node), 0) AS ischild
         FROM
         (SELECT
         unique_id as node, pid as parent_node
         FROM
         asset_cpe_tree
         WHERE
         status = 1
         ORDER BY parent_node desc, node desc) t1, (SELECT @pids:=#{os}) t2) t3
         WHERE
         ischild != 0
    </select>
</mapper>