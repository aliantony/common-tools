<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.antiy.asset.dao.AssetReportDao">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.antiy.asset.entity.AssetAreaEntity">
        <id column="areaAssetCount" property="areaAssetCount"/>
        <result column="areaId" property="areaId"/>
        <result column="date" property="date"/>
    </resultMap>

    <resultMap id="AssetGroupResultMap" type="com.antiy.asset.entity.AssetGroupEntity">
        <result column="asset_group_id" property="groupId"></result>
        <result column="assetGroupName" property="name"></result>
        <result column="countNum" property="groupCount"></result>
        <result column="date" property="date"></result>
    </resultMap>
    <!--获取所有的统计数据-->
    <select id="getAllAssetWithArea" resultType="java.util.Map"
            parameterType="com.antiy.asset.vo.request.ReportQueryRequest">
        SELECT
        <trim suffixOverrides=",">
            <foreach collection="assetAreaIds" item="item">
                sum(CASE WHEN area_id IN (#{item.parentAreaId},
                <foreach collection="item.childrenAradIds" separator="," item="area">
                    #{area}
                </foreach>
                )
                THEN 1
                ELSE 0
                END
                ) AS #{item.parentAreaName},
            </foreach>
        </trim>
        FROM
        asset
        WHERE
        gmt_create &lt;= #{endTime}
        AND asset_status != '9'
        AND STATUS = 1
    </select>
    <!--统计初始数据-->
    <select id="queryAssetWithAreaByDate" resultType="java.util.Map">
        SELECT
        CASE
        <foreach collection="list" item="item">
            WHEN area_id IN (#{item.parentAreaId},
            <foreach collection="item.childrenAradIds" separator="," item="area">
                #{area}
            </foreach>
            ) THEN #{item.parentAreaId}
        </foreach>
        END AS areaId,
        count(1) AS assetCount
        FROM
        asset
        WHERE
        gmt_create &lt; #{startTime}
        AND asset_status != '9'
        AND STATUS = 1
        AND area_id in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item.parentAreaId},
            <foreach collection="item.childrenAradIds" separator="," item="area">
                #{area}
            </foreach>
        </foreach>
        GROUP BY
        areaId
    </select>
    <!--统计区域每个区间的增量-->
    <select id="queryAddAssetWithArea" resultType="java.util.Map">
        SELECT
        replace(ltrim(replace(FROM_UNIXTIME(gmt_create/1000,#{timeType}),'0',' ')),' ','0') AS date,
        <trim suffixOverrides=",">
            <foreach collection="list" item="item">
                sum(CASE WHEN area_id IN (#{item.parentAreaId},
                <foreach collection="item.childrenAradIds" separator="," item="area">
                    #{area}
                </foreach>
                )
                THEN 1
                ELSE 0
                END
                ) AS #{item.parentAreaName},
            </foreach>
        </trim>
        FROM
        asset
        WHERE
        gmt_create &lt; #{endTime}
        and gmt_create > #{startTime}
        AND asset_status != '9'
        AND STATUS = 1
        GROUP BY
        date
        ORDER BY
        date ASC
    </select>

    <select id="getAssetConutWithGroup" parameterType="com.antiy.asset.vo.request.ReportQueryRequest"
            resultType="com.antiy.asset.entity.AssetGroupEntity">
        SELECT
        count(1) AS groupCount,
        ag.id AS groupId,
        ag.name AS name
        FROM
        asset_group_relation agr
        LEFT JOIN asset_group ag ON agr.asset_group_id = ag.id
        LEFT JOIN asset ON asset.id = agr.asset_id

        WHERE agr.gmt_create &lt;=#{endTime}
        AND asset.asset_status != '9'
        AND agr. STATUS = 1
        AND asset. STATUS = 1
        <if test="areaIds != null and areaIds.size() > 0">
            and asset.area_id in
            <foreach index="index" item="item" collection="areaIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        GROUP BY
        groupId,
        name
        ORDER BY groupCount desc
        <if test="topFive">
            LIMIT 0,5
        </if>

    </select>


    <sql id="timeType">
        <choose>
            <when test="timeType==1">
                '%w'
            </when>
            <when test="timeType==2">
                '%u'
            </when>
            <otherwise>
                '%Y-%m'
            </otherwise>
        </choose>
    </sql>

    <select id="findCategoryCountByTime" resultType="com.antiy.asset.entity.AssetCategoryEntity"
            parameterType="com.antiy.common.base.ObjectQuery">
        SELECT
        count(1) AS categoryCount,
        asset.category_model AS categoryModel,
        replace(ltrim(replace(FROM_UNIXTIME(asset.gmt_create/1000,#{format}),'0',' ')),' ','0') AS date,
        acm.parent_id as parentId,
        acm.name as categoryName
        FROM
        asset
        LEFT JOIN asset_category_model acm ON acm.id = asset.category_model
        WHERE
        asset.gmt_create &lt;= #{endTime}
        <if test="areaIds!=null and areaIds.size()>0">
            and area_id in
            <foreach item="areaId" collection="areaIds" open="(" separator="," close=")">
                #{areaId}
            </foreach>
        </if>
        AND asset.gmt_create > #{beginTime}
        AND asset.`status` &lt;&gt; 9
        AND asset.category_model IS NOT NULL
        GROUP BY
        asset.category_model,
        date
    </select>

    <select id="findCategoryCountPrevious" resultType="com.antiy.asset.entity.AssetCategoryEntity"
            parameterType="com.antiy.common.base.ObjectQuery">
        SELECT
        count( 1 ) AS categoryCount,
        asset.category_model AS categoryModel,
        acm.parent_id as parentId,
        acm.name as categoryName
        FROM
        asset
        LEFT JOIN asset_category_model acm ON acm.id = asset.category_model
        WHERE
        asset.gmt_create &lt;= #{beginTime}
        <if test="areaIds!=null and areaIds.size()>0">
            and area_id in
            <foreach item="areaId" collection="areaIds" open="(" separator="," close=")">
                #{areaId}
            </foreach>
        </if>
        AND asset.`status` &lt;&gt; 9
        AND asset.category_model IS NOT NULL
        GROUP BY
        asset.category_model
    </select>

    <select id="findCategoryCountAmount" resultType="int"
            parameterType="map">
        SELECT
        count( 1 )
        FROM
        asset
        WHERE
        asset.gmt_create &lt;= #{beginTime}
        AND asset.`status` &lt;&gt; 9
        AND asset.category_model IS NOT NULL
        and asset.category_model = #{categoryModel}
    </select>

    <select id="getNewAssetWithGroup" parameterType="com.antiy.asset.vo.request.ReportQueryRequest"
            resultMap="AssetGroupResultMap">
        SELECT
        agr.asset_group_id,ag.`NAME` as assetGroupName,count(agr.asset_group_id) as countNum,
        replace(ltrim(replace(FROM_UNIXTIME(agr.gmt_create/1000,#{sqlTime}),'0',' ')),' ','0') AS date
        FROM
        asset_group_relation agr
        LEFT JOIN asset_group ag ON agr.asset_group_id = ag.id
        LEFT JOIN asset on agr.asset_id = asset.id
        <where>
            <if test="endTime != null and endTime !=''">
                and agr.gmt_create &lt;= #{endTime}
            </if>
            <if test=" startTime != null and startTime != ''">
                AND agr.gmt_create &gt;= #{startTime}
            </if>
            <if test="groupIds != null and groupIds.size()>0">
                AND ag.id in
                <foreach item="groupId" collection="groupIds" open="(" separator="," close=")">
                    #{groupId}
                </foreach>
            </if>
            <if test="areaIds != null and areaIds.size() > 0">
                and asset.area_id in
                <foreach index="index" item="item" collection="areaIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND asset.status = 1
            AND asset.asset_status != 9
        </where>
        GROUP BY
        agr.asset_group_id,
        date
        ORDER BY `date` asc
    </select>
</mapper>
